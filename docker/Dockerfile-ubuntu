FROM ubuntu:24.04

# Metadata
LABEL maintainer="lab@example.com"
LABEL description="Ubuntu 24.04 container for Linux training lab"
LABEL version="1.2"

# Evita prompt interattivi durante installazione
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Rome

# Ottimizzazione: disabilita installazione documentazione
RUN echo 'path-exclude /usr/share/doc/*' > /etc/dpkg/dpkg.cfg.d/01_nodoc && \
    echo 'path-exclude /usr/share/man/*' >> /etc/dpkg/dpkg.cfg.d/01_nodoc && \
    echo 'path-exclude /usr/share/groff/*' >> /etc/dpkg/dpkg.cfg.d/01_nodoc && \
    echo 'path-exclude /usr/share/info/*' >> /etc/dpkg/dpkg.cfg.d/01_nodoc && \
    echo 'path-include /usr/share/man/man[1-9]/*' >> /etc/dpkg/dpkg.cfg.d/01_nodoc

# Installa systemd e strumenti base in un unico layer ottimizzato
RUN apt-get update && apt-get install -y --no-install-recommends \
    systemd \
    systemd-sysv \
    openssh-server \
    sudo \
    vim \
    nano \
    htop \
    net-tools \
    iputils-ping \
    curl \
    cockpit \
    cockpit-storaged \
    wget \
    git \
    rsync \
    man-db \
    less \
    tmux \
    screen \
    netcat-openbsd \
    dnsutils \
    tree \
    cron \
    rsyslog \
    procps \
    psmisc \
    lsof \
    strace \
    tcpdump \
    iproute2 \
    iptables \
    ca-certificates \
    gnupg \
    tzdata \
    locales \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/cache/apt/archives/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/* \
    && find /var/log -type f -delete

# Configura locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Cleanup systemd per container
RUN systemctl mask \
    systemd-remount-fs.service \
    dev-hugepages.mount \
    sys-fs-fuse-connections.mount \
    systemd-logind.service \
    getty.target \
    console-getty.service \
    systemd-udev-trigger.service \
    systemd-udevd.service \
    systemd-random-seed.service \
    systemd-machine-id-commit.service

# Configura SSH e abilita servizi
RUN mkdir -p /var/run/sshd /root/.ssh && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    systemctl enable ssh && \
    systemctl enable cockpit.socket && \
    systemctl enable cron

# Crea utente student SENZA password
# La password sarà impostata dinamicamente all'avvio del container
# tramite la variabile d'ambiente STUDENT_PASSWORD
RUN useradd -m -s /bin/bash -u 1001 -G sudo student && \
    mkdir -p /home/student/.ssh && \
    chown -R student:student /home/student && \
    chmod 700 /home/student/.ssh

# Configura sudo
RUN echo "student ALL=(ALL) NOPASSWD: /usr/bin/systemctl, /usr/bin/apt, /usr/bin/journalctl" >> /etc/sudoers.d/student && \
    echo "student ALL=(ALL) ALL" >> /etc/sudoers.d/student && \
    chmod 440 /etc/sudoers.d/student

# Disabilita root login
RUN passwd -l root

# Copia script
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
COPY setup-ssh-keys.sh /usr/local/bin/setup-ssh-keys.sh
COPY sudoers-config.sh /usr/local/bin/sudoers-config.sh
RUN chmod +x /usr/local/bin/*.sh

# Banner di benvenuto
RUN cat > /etc/motd << 'EOF'
╔═══════════════════════════════════════╗
║     LINUX TRAINING LAB - UBUNTU 24.04     ║
╚═══════════════════════════════════════╝

Welcome to your Linux training environment!
Type 'cat ~/README.txt' for instructions.

EOF

# README per studente
RUN cat > /home/student/README.txt << 'EOF'
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LABORATORIO LINUX - UBUNTU 24.04 LTS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

INFORMAZIONI SISTEMA:
- Distribuzione: Ubuntu 24.04 LTS
- Kernel: $(uname -r)
- Package Manager: apt
- Init System: systemd

NETWORK:
- Client: $(hostname)
- Server1: server1 (SSH ready)
- Server2: server2 (SSH ready)

COMANDI RAPIDI:
┌─────────────────────────────────────────┐
│ ssh server1          → Connetti server1 │
│ ssh server2          → Connetti server2 │
│ sudo <comando>       → Esegui come root │
│ systemctl status ssh → Status servizi   │
│ journalctl -xe       → System logs      │
│ htop                 → Monitor processi │
└─────────────────────────────────────────┘

ESERCITAZIONI:
Segui le istruzioni del docente.
I file delle esercitazioni sono in ~/exercises/

SUPPORTO:
Per problemi tecnici contatta il docente.

Buon lavoro! 🚀
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOF

# Crea struttura home student e log directory
RUN chown student:student /home/student/README.txt && \
    mkdir -p /home/student/exercises && \
    chown -R student:student /home/student/exercises && \
    mkdir -p /var/log/sudo && \
    touch /var/log/sudo.log && \
    chmod 600 /var/log/sudo.log

# Volume per systemd
VOLUME [ "/sys/fs/cgroup" ]

# Expose SSH
EXPOSE 22

# Healthcheck
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD systemctl is-active ssh || exit 1

# Entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Systemd come init
CMD ["/lib/systemd/systemd"]
